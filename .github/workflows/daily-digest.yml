name: Daily YouTube Digest

on:
  schedule:
    - cron: '0 0 * * *' # Daily at 00:00 UTC
  workflow_dispatch:
    inputs:
      video_id:
        description: 'Specific Video ID to process'
        required: false
        default: 'hYF4fQYlrso'

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Install yt-dlp and ffmpeg
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Restore Processed Videos State
        id: cache-state
        uses: actions/cache@v4
        with:
          path: data/processed_videos.json
          key: youtube-state-${{ github.run_id }}
          restore-keys: |
            youtube-state-

      - name: Run ReadTube Pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          mkdir -p data
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.video_id }}" ]; then
            # Still allow manual override for a specific video via test script
            npx ts-node scripts/run_pipeline.ts ${{ github.event.inputs.video_id }}
          else
            # Daily digest mode: check all channels
            npx ts-node src/index.ts
          fi

      - name: Save State
        if: always()
        uses: actions/cache/save@v4
        with:
          path: data/processed_videos.json
          key: youtube-state-${{ github.run_id }}

      - name: Upload Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: youtube-intelligence-report
          path: latest_report.html
